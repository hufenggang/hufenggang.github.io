---
layout:     post
title:      数仓建设
subtitle:   数仓建设详解
date:       2020-04-21
author:     MichealHu
header-img: img/post-bg-swift2.jpg
catalog: true
tags:
    - 数仓
---

# 数仓建设详解

本文从笔者自身实践的角度出发，结合自身对数据仓库建设的相关经验，详细介绍数仓构建过程和数据建模相关方法论。在文章中涉及到相关的专业术语，读者如果有不理解可以参看《数仓建模名词解释》一篇。本文也是笔者从0到1构建数仓的一次经验总结，其主要目的是：工作中学习、学习中成长，进而形成一套属于自己的数据建模方法论。笔者也是希望本文能够给读者提供相关参考。

本文主要的主线就是回答下面三个问题：

1. 为什么需要数据建模？
2. 如何从0到1搭建数据仓库？
3. 数仓建设过程中需要注意什么？

最后，笔者在本文的结尾给大家介绍了一个具体的数仓建设样例，帮助大家来了解整个数仓建设的过程。

## 一、概述

随着DT时代的来临，互联网、智能终端设备和其它信息技术的快速发展，导致用户数据成爆发式增长，而对于企业来讲，需要将这些业务数据进行有结构的分类存储，以便于服务企业的业务等部门。数据模型就是数据组织和存储的方法。它强调从业务、数据存取和使用角度合理存储数据。构建出适合企业的数据模型。而构建数仓的目的主要体现在如下几个方面：

1. 提高数据查询性能。企业业务表一般存储在关系型数据库，而关系型数据库设计需要严格规范化，这样就导致业务人员查询相关数据的时候需要关联多张数据表，也可能出现跨业务库查询的情况，查询性能严重受阻。而构建数据仓库将不同业务库数据统一接进来，构建数据模型，简化查询逻辑，大大提升了数据查询性能。
2. 缩减企业成本；
3. 提高数据使用效率；
4. 改善数据质量。

数仓构建中最重要也是最大的一个痛点就是数据建模。好的数据模型可以很大程度上提升企业数据质量，也极大地方便了后期的迭代开发。目前行业内常用的数据建模方法论主要有如下几种：

1. 数据仓库之父 Bill lnmon提出的ER模型；
2. 数据仓库领域的 Ralph Kimball 提出的维度建模。

本文主要选择维度建模的思想实现数仓的数据建模。

## 二、数仓建设过程

在笔者最开始构建数仓的时候，碰到的一个最大的问题就是：不知道从哪里下手去搭建企业的数据仓库，构建的数仓会不会存在取数困难的情况。笔者参考阿里的数仓建模思想（见《大数据之路：阿里巴巴大数据实践》一书），学习网上同行业企业的数仓构建过程，实现企业级数仓建设。笔者将数据仓库建设的重要部分概括为：**业务调研、数据建模、开发测试、模型上线**。接下来对每部分进行详细说明，笔者在下边罗列出了每个步骤的产出，读者可作为参考。

### 2.1 业务调研

构建数据仓库首先需要对公司业务系统的所有业务线进行全面了解，了解各个业务领域、业务线的业务有什么共同点和不同点，以及各个业务线可以细分为哪几个业务模块，每个业务模块具 体的业务流程又是怎样的。业务调研是否充分，将会影响我们构建出来的数据仓库是否成功。而这部分的具体工作包括：业务调研和需求分析：

- 业务调研：需要对业务系统的业务进行了解。
- 需求分析：收集分析师或运营人员对数据或报表的需求。

业务调研过程的产出包括：业务需求文档、业务过程开发文档。

### 2.2 数据建模

数仓建设的主要工作集中在该阶段。数据建模相关内容较多，文档第三章专门讲解，此处先不做过多赘述。

数据建模过程的需求包括：需求调研文档、业务指标和口径文档。

数据建模过程的产出包括：数据模型设计文档（包括：业务总线矩阵、事实表设计、维度表设计、开发规范文档等）

### 2.3 开发测试

开发测试主要工作是根据数据模型设计文档，实现事实表和维度表的脚本开发，调度流脚本开发、监控任务和元数据管理等开发工作，脚本测试和数据diff等工作。

开发测试过程的需求包括：数据模型设计文档。

开发测试过程的产出包括：脚本、测试报告。

### 2.4 模型上线

完成验证后的模型就可以在线上生产环境进行部署。上线后需要为模型配置监控，及时掌握为业务提供数据服务的状况。我们还将模型的实体和属性说明文档发布给仓库数据的使用者，使模型得到更好地应用。

模型上线过程的需求包括：数据模型设计文档、脚本。

模型上线过程的产出包括：数据调度任务，模型发布文档。

## 三、数据建模

本文建模过程主要以维度建模理论为指导，基于维度数据模型总线架构，构建一致性的维度和事实。可以简单的描述为：按照事实表，维度表表来构建数据仓库，数据集市。就是市场上常见的星型模式（`Star-schema`）。维度建模的最大的作用其实是为了解决数据仓库建模中的性能问题。维度建模很难能够提供一个完整地描述真实业务实体之间的复杂关系的抽象方法，所以维度建模只适用于数据集市层。

### 3.1  模型分层

笔者参考行业内常见数仓分层架构，把表数据模型分为四层：预处理层（STG）、数据操作层（ ODS ）、 公共维度模型层（ ADM）和数据应用层（ ADS ）， 其中公共维度模型层包括：数据明细层（ DWD ）和数据汇总层（ DWS ）。架构图如下所示：

#### 1、预处理层（STG）

预处理层主要缓存来自 DB 、消息、日志解析落地的临时数据，结构与业务系统保持一致。负责对脏数据进行清理，不进行业务逻辑处理。该层只为 ODS 层提供服务。

#### 2、数据操作层（ ODS ）

数据操作层负责保留数据接入时点后历史变更数据，数据原则上全量保留。模型设计依据业务表数据变更特性采取拉链表和流水表两种形式。

#### 3、公共维度模型层（ ADM）

包括DIM、DWD和DWS，由ODS层数据加工而成。主要完成数据加工与整合，建立一致性的维度，构建可复用的面向分析和统计的明细事实表，以及汇总公共粒度的指标。

#### 4、数据应用层（ ADS ）

存放数据产品个性化的统计指标数据。根据CDM与ODS层加工生成。

### 3.2  数据建模实施

数据仓库建模阶段主要划分为：业务建模、数据域建模、逻辑建模、物理建模。

#### 1、业务建模

业务调研阶段已整理企业所有业务需求。针对业务需求就可以开始实现业务建模。这部分建模工作主要是划分业务过程。

#### 2、数据域建模

根据业务建模划分的业务过程，划分数据域

业务调研阶段已整理企业所有业务过程。针对该业务过程构建业务数据矩阵，完成业务建模。

### 3.3  事实表设计

####  1、事务事实表

事务事实表设计过程：

1. 选择业务过程
2. 确定粒度
3. 确定维度
4. 确定事实
5. 冗余维度，也叫作退化维度

单事务事实表：针对每个业务过程设计一个事实表。优点是：可以方便地对每个业务过程进行独立的分析研究。选定业务过程后，将对每个业务过程确定粒度、维度和事实。

多事务事实表：将不同的事实放到同一个事实表中，即同一个事实表包含不同的业务过程。多事务事实表在设计时有两种方法进行事实的处理：①不同业务过程的事实使用不同的事实字段进行存放：①不同业务过程的事实使用同一个事实字段进行存放，但增加一个业务过程标签。

多事务事实表设计的两种场景和方式：

1. 当不同业务过程的度量比较相似、差异不大时：使用同一个字段来表示度量数据。
2. 当不同业务过程的度量差异较大时：将不同业务过程的度量使用不同字段冗余到表中，非当前业务过程则置零表示。

事实的设计准则：

1. 事实完整性：
2. 事实一致性：
3. 事实可加性：

#### 2、周期快照事实表

特性：

1. 用快照采样状态
2. 快照粒度
3. 密度和稀疏性
4. 半可加性

快照事实表的设计步骤：

1. 确定快照事实表的快照粒度。
2. 确定快照事实表采样的状态度量。

快照事实表常见分类：

1. 单维度的每天快照事实表
2. 混合维度的每天快照事实表
3. 全量快照事实表

一般来说，周期快照事实表可以从事务事实表进行汇总产出；或者直接使用操作型系统的数据作为周期快照事实表的数据源进行加工。

设计注意事项：

1. 事务与快照成对设计
2. 附加事实
3. 周期到日期度量

#### 3、累计快照事实表

设计过程：

1. 选择业务过程
2. 确定粒度
3. 确定维度
4. 确定事实
5. 退化维度

特点：

1. 数据不断更新
2. 多业务过程日期

实现：

1. 第一种方式是全量表的形式。
2. 第二种方式是全量表的变化形式。
3. 第三种方式是以业务实体的结束时间分区。

### 3.4  维度表设计

#### 1、维表设计步骤

关于数据仓库维度表的设计可以从整体上概括为如下几个步骤：

1. 第一步：选择维度或新建维度。在企业级数据仓库中必须保证维度的唯一性，而选择维度这个过程变得异常重要，关乎后期数仓的迭代开发和使用。
2. 第二步：确定主维表。确定和业务系统同步的主维表。
3. 第三步：确定相关维表。数据仓库是所有业务源系统的数据整合，不同业务系统或者同一业务系统中的不同表之间存在关联性。我们需要梳理相关业务，确定哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。
4. 第四步：确定维度属性。从主维表和相关维表中选择维度属性或生成新的维度属性。

如上四个步骤基本确定了数仓维度表设计的过程，可作为参考用于实际数仓构建中。在我们进行数仓维度设计的时候提出如下几个建议：

1. 尽可能生成丰富的维度属性。尽量满足维度表的维度属性丰富，可用性强。设计公共维度表时需要考虑使用该维度表的其它业务场景下的相关维度属性。
2. 尽可能多地给出包括一些富有意义的文字性描述。例如：支付状态属性，对应字段可能为：0.未支付, 1.支付成功, 2.支付失败, 3 取消支付。可以新增支付状态描述属性，对应生成文字信息，方便业务部门查询。
3. 区分数值型属性和事实。在我们设计过程中可能会碰到数值型属性，不知道到底是作为维度属性合适还是作为事实合适。在此提出如下建议：（可作为参考，不是绝对的）如果通常用于查询约束条件或分组统计，则是作为维度属性；如果通常用于参与度量的计算， 则是作为事实。如果数值型字段是离散值，则作为维度属性存在的可能性较大；如果数 值型宇段是连续值 ，则作为度量存在的可能性较大，
4. 尽量沉淀出通用的维度属性。在同一个维度表的不同维度属性的数据来源和处理逻辑可能不尽相同，此时需要将尽可能多的通用的维度属性进 行沉淀。一方面可以提高下游使用的方便性，减少复杂度；另 一方面能可以避免下游使用解析时由于各自逻辑不同而导致口径不一致。

一致性维度和交叉探查

1. 维度的层次结构；
2. 规范化和反规范化；
3. 一致性维度和交叉探查；

#### 2、维表设计思想

在实际数仓开发过程中，维度表的常见设计思想有如下几个：

1. 维度整合
2. 水平拆分
3. 垂直拆分
4. 历史归档

接下来针对每一种设计思想详细说明：

##### 维度整合

面向应用的业务数据进入数据仓库后，需要进行数据集成。将面向应用的数据转换为面向主题的数据仓库数据本身就是一种集成。具体体现在如下几个方面：

1. 命名规范的统一。表名、字段名等统一。
2. 字段类型的统一。 相同和相似字段的字段类型统一。
3. 公共代码及代码值的统一。公共代码及标志性宇段的数据类型、命名方式等统一。
4. 业务含义相同的表的统一。主要依据高内聚、低稠合的理念，在物理实现中，将业务关系大、源系统影响差异小的表进行整合：将业务关系小、游、系统影响差异大 的表进行分而置之。通常有如下几种集成方式：

维度表的整合主要有两种表现形式：垂直整合和水平整合。

- 垂直整合。不同的来源表包含相同的数据集，只是存储的信息不同。比如会员基础信息表、会员扩展信息表、会员等级信息表，这些表都属于会员相关信息表，依据维度设计方法，尽量整合至会员维度模型中，丰富其维度属性。
- 水平整合。即不同的来源表包含不同的数据集，不同子集 之间无交叉，也可以存在部分交叉。比如商场会员表和线上超市会员表可以实现水平整合。

##### 水平拆分

维度通常可以按照类别或类型进行细分。电商类用户可以按照会员等级细分为普通会员和高级会员等，所有用户包含基础用户属性，但是会员中的经销商可能还包含一些如客户收益，购买商品折扣等特殊属性。此时我们需要考虑如何设计维度，常用有两种设计方案：

- 方案1是将维度的不同的分类实例化为不同的维度，同时在主维度中保存公共属性。方案2是维护单一维度，包含所有可能的属性。
- 方案2是维护单一维度，包含所有可能的属性。



##### 垂直拆分

##### 历史归档

## 四、数仓建设样例

## 参考资料

1. [浅谈数据仓库建设中的数据建模方法](https://www.ibm.com/developerworks/cn/data/library/techarticles/dm-0803zhousb/index.html)
2. [美团点评酒旅数据仓库建设实践](https://tech.meituan.com/2017/05/26/hotel-dw-layer-topic.html)
3. [马蜂窝数据中台起步建设：数仓的架构、模型与应用](https://dbaplus.cn/news-141-2815-1.html)
4. [数据仓库实践之业务数据矩阵的设计](https://cloud.tencent.com/developer/article/1396893)
5. [数据仓库开发技巧](https://github.com/dantezhao/data-warehouse/blob/master/the-tips-of-data-warehouse.md)